<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../oc-core-utils/oc-core-utils.html">

<dom-module id="oc-accounts-api">>
    <template>
        <iron-ajax id="getAccountTypes"></iron-ajax>
        <iron-ajax id="addOrganisationAccount"></iron-ajax>
        <iron-ajax id="getOrganisationAccounts"></iron-ajax>
        <iron-ajax id="getOrganisationTransactions"></iron-ajax>
        <iron-ajax id="getOrganisationTransaction"></iron-ajax>
        <iron-ajax id="downloadStatement"></iron-ajax>
        <iron-ajax id="addUserAccount"></iron-ajax>
        <iron-ajax id="getUserAccounts"></iron-ajax>
        <iron-ajax id="getAccount"></iron-ajax>
        <iron-ajax id="updateAccount"></iron-ajax>
        <iron-ajax id="updateOrganisationAccount"></iron-ajax>
        <iron-ajax id="peachRegistration"></iron-ajax>
        <iron-ajax id="removeAccount"></iron-ajax>
    </template>

    <script>
        /**
         * `oc-accounts-api`
         * Ordercloud API calls for accounts endpoint
         *
         * @customElement
         * @polymer
         * @demo demo/index.html
         */
        class OcAccountsApi extends Ordercloud.ApiMixin(Polymer.Element) {
            static get is() { return 'oc-accounts-api'; }
            static get properties() {};

            /**
             * Retrieve all account types
             * @param type personal , business or markeptlace
             * @return {Promise}
             */
            getAccountTypes(type) {
                this.$.getAccountTypes.url = this._generateUrl('accounts/types?filter=' + type);
                return this._generateRequest(this.$.getAccountTypes);
            }


            /**
             * Create a new user account
             *
             * @return {Promise}
             */
            addUserAccount(userId, accountData) {
                // var _data = accountData;
                this.$.addUserAccount.url = this._generateUrl('users/' + userId + '/accounts');
                this.$.addUserAccount.method = "POST";
                this.$.addUserAccount.contentType = "application/json";
                this.$.addUserAccount.body = accountData;
                return this._generateRequest(this.$.addUserAccount);
            }

            /**
             * Retrieve an user account
             *
             * @return {Promise}
             */
            getUserAccounts(accountId) {
                this.$.getUserAccounts.url = this._generateUrl('users/' + accountId +'/accounts');
                return this._generateRequest(this.$.getUserAccounts);
            }

            /**
             * Create a new organisation account
             *
             * @return {Promise}
             */
            addOrganisationAccount(organisationId, accountData) {
                // var _data = accountData;
                this.$.addOrganisationAccount.url = this._generateUrl('organisations/' + organisationId + '/accounts');
                this.$.addOrganisationAccount.method = "POST";
                this.$.addOrganisationAccount.contentType = "application/json";
                this.$.addOrganisationAccount.body = accountData;
                return this._generateRequest(this.$.addOrganisationAccount);
            }

            /**
             * Retrieve an organisation account
             *
             * @return {Promise}
             */
            getOrganisationAccounts(organisationId, kind) {

                let queryParams = '';
                if(kind){
                    queryParams = '?kind=' + kind;
                }
                this.$.getOrganisationAccounts.url = this._generateUrl('organisations/' + organisationId + '/accounts' + queryParams);
                return this._generateRequest(this.$.getOrganisationAccounts);
            }

            /**
             * Retrieve an account
             *
             * @return {Promise}
             */
            getAccount(accountId) {
                this.$.getAccount.url = this._generateUrl('accounts/'+ accountId);
                return this._generateRequest(this.$.getAccount);
            }




            /**
             * Retrieve an account
             *
             * @param accountId to fetch transactions for
             * @param fromDate transaction filter
             * @param toDate transaction filter
             * @param transactionType transactionType allowed filter [control, purchase, fee]
             * @return {Promise}
             */
            getAccountTransactions(accountId, fromDate, toDate,transactionType) {

                let filter = '';
                if((transactionType)&&(transactionType.toLowerCase() === "all")){
                    filter = '?transaction_type=' + transactionType;
                }
                this.$.getAccount.url = this._generateUrl('accounts/'+ accountId + '/transactions' + filter);
                return this._generateRequest(this.$.getAccount);
            }

            /**
             * Retrieve all transaction for organisation
             *
             * @param organisationId to fetch transactions for
             * @return {Promise}
             */
            getOrganisationTransactions(organisationId) {
                this.$.getOrganisationTransactions.url = this._generateUrl(`organisations/${organisationId}/transactions`);
                return this._generateRequest(this.$.getOrganisationTransactions);
            }

            /**
             * Retrieve all transaction for organisation
             *
             * @param organisationId to fetch transactions for
             * @return {Promise}
             */
            getOrganisationTransaction(organisationId, referenceId) {
                this.$.getOrganisationTransaction.url = this._generateUrl(`organisations/${organisationId}/transactions/${referenceId}`);
                return this._generateRequest(this.$.getOrganisationTransaction);
            }

			/**
			 * Download defined statement for organisation
			 *
			 * @param organisationId to fetch transactions for
			 * @return {Promise}
			 */
			downloadStatement(organisationId, fromDate, toDate) {
				this.$.downloadStatement.url = this._generateUrl(`organisations/${organisationId}/transactions/statements/download?format=pdf`);
				this.$.downloadStatement.responseType = "blob";
				this.$.downloadStatement.handleAs = "blob";
				return this._generateRequest(this.$.downloadStatement);
			}

            /**
             * Update an account's details
             *
             * @return {Promise}
             */
            updateAccount(userId) {
                this.$.updateAccountDetails.url = this._generateUrl('accounts/' + userId);
                this.$.updateAccountDetails.method = "PUT";
                this.$.updateAccountDetails.contentType = "application/json";
                this.$.updateAccountDetails.body = accountDetails;
                return this._generateRequest(this.$.updateAccount);
            }

            /**
             * Update an organisation's details
             *
             * @return {Promise}
             */
            updateOrganisationAccount(organisationId) {
                this.$.updateAccountDetails.url = this._generateUrl('accounts/' + organisationId);
                this.$.updateAccountDetails.method = "PUT";
                this.$.updateAccountDetails.contentType = "application/json";
                this.$.updateAccountDetails.body = accountDetails;
                return this._generateRequest(this.$.updateAccount);
            }


            /**
             * Remove an account
             *
             * @param accountId to remove
             * @return {Promise}
             */
            removeAccount(accountId) {
                this.$.removeAccount.url = this._generateUrl('accounts/' + accountId);
                this.$.removeAccount.method = "DELETE";
                return this._generateRequest(this.$.removeAccount);
            }

            /**
             * Checkout ID from peach for card registration
             *
             * returns response.body.id checkout id from peach
             *
             * @return {Promise}
             */
            peachRegistration() {
                this.$.peachRegistration.url = this._generateUrl('accounts/peach-registration');
                this.$.peachRegistration.method = "GET";
                this.$.peachRegistration.contentType = "application/json";
                return this._generateRequest(this.$.peachRegistration);
            }

        }

        window.customElements.define(OcAccountsApi.is, OcAccountsApi);
    </script>
</dom-module>
